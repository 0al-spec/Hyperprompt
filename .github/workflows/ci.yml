name: CI

# CI workflow for Hyperprompt Swift compiler
# Triggers on PR, push to main, and manual dispatch
# Runs on Linux (ubuntu-latest) with Swift 6.0.3

on:
  pull_request:
    branches: [main]
    paths:
      - 'Sources/**/*.swift'
      - 'Tests/**/*.swift'
      - 'Package.swift'
      - 'Package.resolved'
      - '.github/workflows/**'
    paths-ignore:
      - 'DOCS/**'

  push:
    branches: [main]
    paths:
      - 'Sources/**/*.swift'
      - 'Tests/**/*.swift'
      - 'Package.swift'
      - 'Package.resolved'
      - '.github/workflows/**'
    paths-ignore:
      - 'DOCS/**'

  workflow_dispatch:

# Least-privilege permissions for GitHub Actions
# Restricts token scope to minimize potential blast radius if workflow is compromised
# Reference: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
permissions:
  contents: read

jobs:
  build:
    # Linux-only CI job (macOS/Windows deferred to future tasks)
    # Uses Swift 6.0.3 (compatible with Package.swift minimum 5.9)
    # Caches dependencies based on Package.resolved hash
    runs-on: ubuntu-latest

    steps:
      # Validate secrets configuration (fail fast on missing required secrets)
      # Currently: No required secrets for baseline CI
      # Optional: CI_TOKEN (placeholder for future stages like artifact publishing)
      # Uncomment and update this block if secrets become required
      - name: Validate secrets
        run: |
          echo "Checking required secrets..."
          # No required secrets at this stage
          echo "âœ“ Secrets validation passed"

      # Clone repository with full git history
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install Swift 6.0.3 toolchain
      # Version pinned per CI-01 audit findings
      - name: Install Swift 6.0.3
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0.3'

      # Verify Swift installation
      - name: Verify Swift version
        run: |
          swift --version
          swift --version | grep -q "6.0.3"

      # Cache .build and .swiftpm for 60-80% speedup on subsequent runs
      # Cache key includes Package.resolved hash for deterministic invalidation
      - name: Cache Swift dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # Resolve Swift Package Manager dependencies
      - name: Resolve dependencies
        run: |
          echo "Resolving Swift dependencies..."
          swift package resolve
          echo "Dependencies resolved successfully"

      # Display cache statistics for debugging
      - name: Cache statistics
        if: always()
        run: |
          echo "Build directory size:"
          du -sh .build 2>/dev/null || echo "No .build directory yet"
          echo "SwiftPM cache size:"
          du -sh .swiftpm 2>/dev/null || echo "No .swiftpm directory yet"

      # Build the Swift package
      - name: Build
        run: |
          echo "Building Swift package..."
          swift build --build-tests
          echo "Build completed successfully"

      # Run tests with parallel execution
      - name: Run tests
        run: |
          echo "Running Swift tests..."
          swift test --parallel
          echo "Tests completed successfully"

      # Upload test results and build artifacts on failure
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: |
            .build/debug/*.xctest
            .build/**/*.swiftmodule
            .build/debug.yaml
          retention-days: 7
          if-no-files-found: warn

      # Display build summary
      - name: Build summary
        if: always()
        run: |
          echo "================================"
          echo "Build and Test Summary"
          echo "================================"
          echo "Build artifacts:"
          ls -lh .build/debug/ 2>/dev/null || echo "No build artifacts"
          echo "================================"

  build-without-editor-trait:
    # Validate that default builds exclude EditorEngine when no traits are enabled.
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Swift 6.0.3
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0.3'

      - name: Verify Swift version
        run: |
          swift --version
          swift --version | grep -q "6.0.3"

      - name: Cache Swift dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: |
          echo "Resolving Swift dependencies..."
          swift package resolve
          echo "Dependencies resolved successfully"

      - name: Build without EditorEngine trait
        env:
          SWIFT_PACKAGE_TRAITS: ""
          SWIFT_ENABLE_ALL_TRAITS: "0"
        run: |
          echo "Building Swift package without EditorEngine trait..."
          swift build --build-tests
          echo "Build completed successfully"
