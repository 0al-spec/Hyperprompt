name: CI

# CI workflow for Hyperprompt Swift compiler
# Triggers on PR, push to main, and manual dispatch
# Runs on Linux (ubuntu-latest) with Swift 6.0.3

on:
  pull_request:
  push:
  workflow_dispatch:

# Least-privilege permissions for GitHub Actions
# Restricts token scope to minimize potential blast radius if workflow is compromised
# Reference: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
permissions:
  contents: read

jobs:
  build:
    name: CI - Build and Test
    # Linux-only CI job (macOS/Windows deferred to future tasks)
    # Uses Swift 6.0.3 (compatible with Package.swift minimum 5.9)
    # Caches dependencies based on Package.resolved hash
    runs-on: ubuntu-latest

    steps:
      # Validate secrets configuration (fail fast on missing required secrets)
      # Currently: No required secrets for baseline CI
      # Optional: CI_TOKEN (placeholder for future stages like artifact publishing)
      # Uncomment and update this block if secrets become required
      - name: Validate secrets
        run: |
          echo "Checking required secrets..."
          # No required secrets at this stage
          echo "✓ Secrets validation passed"

      # Clone repository with full git history
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install Swift 6.0.3 toolchain
      # Version pinned per CI-01 audit findings
      - name: Install Swift 6.2.0
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2.0'

      # Verify Swift installation
      - name: Verify Swift version
        run: |
          swift --version
          swift --version | grep -q "Swift version 6.2"

      # Cache .build and .swiftpm for 60-80% speedup on subsequent runs
      # Cache key includes Package.resolved hash for deterministic invalidation
      - name: Cache Swift dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # Resolve Swift Package Manager dependencies
      - name: Resolve dependencies
        run: |
          echo "Resolving Swift dependencies..."
          swift package resolve
          echo "Dependencies resolved successfully"

      # Display cache statistics for debugging
      - name: Cache statistics
        if: always()
        run: |
          echo "Build directory size:"
          du -sh .build 2>/dev/null || echo "No .build directory yet"
          echo "SwiftPM cache size:"
          du -sh .swiftpm 2>/dev/null || echo "No .swiftpm directory yet"

      # Build the Swift package
      - name: Build
        run: |
          echo "Building Swift package..."
          swift build --build-tests
          echo "Build completed successfully"

      # Run tests with parallel execution
      - name: Run tests
        run: |
          echo "Running Swift tests..."
          swift test --parallel
          echo "Tests completed successfully"

      # Upload test results and build artifacts on failure
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: |
            .build/debug/*.xctest
            .build/**/*.swiftmodule
            .build/debug.yaml
          retention-days: 7
          if-no-files-found: warn

      # Display build summary
      - name: Build summary
        if: always()
        run: |
          echo "================================"
          echo "Build and Test Summary"
          echo "================================"
          echo "Build artifacts:"
          ls -lh .build/debug/ 2>/dev/null || echo "No build artifacts"
          echo "================================"

  build-without-editor-trait:
    name: CI - Build without Editor trait
    # Validate that default builds exclude EditorEngine when no traits are enabled.
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Swift 6.2.0
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2.0'

      - name: Verify Swift version
        run: |
          swift --version
          swift --version | grep -q "Swift version 6.2"

      - name: Cache Swift dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: |
          echo "Resolving Swift dependencies..."
          swift package resolve
          echo "Dependencies resolved successfully"

      - name: Build without EditorEngine trait
        env:
          SWIFT_PACKAGE_TRAITS: ""
          SWIFT_ENABLE_ALL_TRAITS: "0"
        run: |
          echo "Building Swift package without EditorEngine trait..."
          swift build --build-tests
          echo "Build completed successfully"

  build-with-editor-trait:
    name: CI - Build with Editor trait
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Swift 6.2.0
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2.0'

      - name: Verify Swift version
        run: |
          swift --version
          swift --version | grep -q "Swift version 6.2"

      - name: Cache Swift dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            .swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}-editor
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}-
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: |
          echo "Resolving Swift dependencies..."
          swift package resolve
          echo "Dependencies resolved successfully"

      - name: Run tests (Editor trait)
        run: |
          echo "Running Swift tests with Editor trait..."
          swift test --traits Editor
          echo "Tests completed successfully"

  vscode-extension-tests:
    name: CI - VS Code Extension Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: Tools/VSCodeExtension
        run: |
          npm install

      - name: Install Xvfb + D-Bus
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb dbus-x11

      - name: Run extension tests
        working-directory: Tools/VSCodeExtension
        run: |
          Xvfb :99 -screen 0 1280x720x24 -nolisten tcp &
          XVFB_PID=$!
          export DISPLAY=:99
          export DBUS_SESSION_BUS_ADDRESS=
          export VSCODE_DISABLE_CRASH_REPORTER=1
          export VSCODE_DISABLE_UPDATE=1
          trap "kill ${XVFB_PID}" EXIT
          dbus-run-session -- npm test

  build-no-cache:
    name: CI - Build without cache (from scratch)
    # Validate that the project builds from scratch without cached dependencies.
    # This ensures reproducible builds and catches cache-related issues.
    # Only runs on pull requests when code, tests, or configuration changes.
    # Complements the cached build job to ensure both scenarios work.
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Validate secrets
        run: |
          echo "Checking required secrets..."
          # No required secrets at this stage
          echo "✓ Secrets validation passed"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Swift 6.2.0
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2.0'

      - name: Verify Swift version
        run: |
          swift --version
          swift --version | grep -q "Swift version 6.2"

      # IMPORTANT: NO cache step - intentionally build from scratch
      # This validates that Package.resolved is complete and reproducible

      - name: Resolve dependencies (no cache)
        run: |
          echo "================================"
          echo "Resolving dependencies from scratch"
          echo "================================"
          echo "Starting at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          swift package resolve
          echo "Dependencies resolved successfully"

      - name: Build from scratch
        run: |
          echo "================================"
          echo "Building from scratch (no cache)"
          echo "================================"
          echo "Starting build at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          START_TIME=$(date +%s)

          swift build --build-tests

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "Build completed in: ${DURATION}s"
          echo "================================"

      - name: Run tests (no cache)
        run: |
          echo "Running tests (no cache)..."
          swift test --parallel
          echo "Tests completed successfully"

      - name: Verify build artifacts
        if: always()
        run: |
          echo "================================"
          echo "Build Artifacts Verification"
          echo "================================"
          echo "Build directory size:"
          du -sh .build 2>/dev/null || echo "No .build directory"
          echo ""
          echo "SwiftPM checkout size:"
          du -sh .build/checkouts 2>/dev/null || echo "No checkouts"
          echo ""
          echo "Executables:"
          find .build -type f -executable -name "hyperprompt" 2>/dev/null || echo "No executables found"
          echo ""
          echo "Test bundles:"
          find .build -type d -name "*.xctest" 2>/dev/null || echo "No test bundles found"
          echo "================================"

      - name: Build summary
        if: always()
        run: |
          echo "================================"
          echo "No-Cache Build Summary"
          echo "================================"
          if [ -d ".build/debug" ]; then
            echo "✓ Build succeeded from scratch"
            echo "Build artifacts:"
            ls -lh .build/debug/ 2>/dev/null | head -20 || echo "No artifacts"
          else
            echo "✗ Build failed - no artifacts generated"
          fi
          echo "================================"

      - name: Upload build artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: no-cache-build-failure-${{ github.run_id }}
          path: |
            .build/debug/*.xctest
            .build/**/*.swiftmodule
            .build/debug.yaml
          retention-days: 7
          if-no-files-found: warn
